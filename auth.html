<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connexion – AnimeHub</title>

  <style>
    body {
      margin: 0;
      background: linear-gradient(180deg,#0b1220 0%, #061226 100%);
      font-family: Inter, sans-serif;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    #authBox {
      background: rgba(255,255,255,0.05);
      padding: 30px;
      border-radius: 12px;
      width: 300px;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.08);
      color: white;
    }

    button {
      padding: 10px;
      border-radius: 8px;
      font-weight: 700;
      border: none;
      cursor: pointer;
    }

    #loginBtn { background: #06b6d4; }
    #signupBtn { background: #0ea5e9; }
    #closeBtn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #ccc; }

    h2 { margin-bottom: 10px; }
  </style>
  <link rel="icon" type="image/png" href="icon_animehub.png" sizes="any" rel="apple-touch-icon" href="icon_animehub.png">
</head>

<body>

  <div id="authBox">
    <h2 id="authTitle">Connexion</h2>

    <input id="authEmail" type="email" placeholder="Email">
    <input id="authPassword" type="password" placeholder="Mot de passe">

    <button id="authSubmit">Valider</button>

    <button id="switchMode">Pas de compte ? Inscription</button>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { 
	getAuth, 
	onAuthStateChanged, 
	signInWithEmailAndPassword, 
	createUserWithEmailAndPassword 
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { 
	getFirestore, 
	doc, 
	setDoc 
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
	apiKey: "AIzaSyCaJZi1Bn1vbeKOC5cM3Gi6nOFyWaH4NK4",
	authDomain: "animehub-7.firebaseapp.com",
	projectId: "animehub-7",
	storageBucket: "animehub-7.firebasestorage.app",
	messagingSenderId: "159114039206",
	appId: "1:159114039206:web:0461d676e7ffff25c4c967",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const authTitle = document.getElementById("authTitle");
  const switchBtn = document.getElementById("switchMode");
  const submitBtn = document.getElementById("authSubmit");

  let mode = "login";

  switchBtn.addEventListener("click", () => {
	if (mode === "login") {
	  mode = "signup";
	  authTitle.textContent = "Inscription";
	  switchBtn.textContent = "Déjà un compte ? Connexion";
	} else {
	  mode = "login";
	  authTitle.textContent = "Connexion";
	  switchBtn.textContent = "Pas de compte ? Inscription";
	}
  });

  submitBtn.addEventListener("click", async () => {
	const email = document.getElementById("authEmail").value;
	const password = document.getElementById("authPassword").value;

	try {
	  if (mode === "login") {
		await signInWithEmailAndPassword(auth, email, password);
		console.log("Utilisateur connecté :", email);

	  } else {
		const cred = await createUserWithEmailAndPassword(auth, email, password);
		console.log("Compte créé avec succès :", cred.user.uid);

		try {
		  const userDoc = doc(db, "users", cred.user.uid);

		  await setDoc(userDoc, {
			username: email.split("@")[0],
			email: email,
			favorites: [],
			ratings: {},
			createdAt: new Date()
		  });

		  console.log("Utilisateur ajouté à Firestore !");
		  alert("Compte créé et enregistré dans Firestore !");

		} catch(firestoreErr) {
		  console.error("Erreur Firestore :", firestoreErr);
		  alert("Le compte a été créé, mais impossible d'enregistrer les données supplémentaires.");
		}
	  }

	  window.location.href = "index.html";

	} catch (err) {
	  console.error("Erreur Auth :", err);
	  alert("Erreur : " + err.message);
	}
  });

  onAuthStateChanged(auth, (user) => {
	if (user) {
	  console.log("Utilisateur déjà connecté :", user.email);
	  window.location.href = "index.html";
	}
  });
  </script>
</body>
</html>
